#!/bin/sh
# =============================================================================
# LightGBM Wine Classification Spark Example - Quick Setup Script
# =============================================================================
# This script creates the required configuration for the wine classification
# end-to-end example. It generates .setup/enabled-services.yaml with:
#   - Training preset: Compute + MLflow
#   - Inference preset: Serve + MLflow
#   - Ray image: ray:2.37.0
#   - Darwin SDK Runtime (Ray + Spark support)
#   - Darwin CLI
# =============================================================================

set -e

# Navigate to project root
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
cd "$PROJECT_ROOT"

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   LightGBM Wine Classification Spark Example - Quick Setup     â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Project root: $PROJECT_ROOT"
echo ""

# Check if yq is available
if ! command -v yq >/dev/null 2>&1; then
  echo "âŒ yq is required but not installed."
  echo "   Please run setup.sh first to install dependencies, or install yq manually."
  exit 1
fi

# Create .setup directory if it doesn't exist
mkdir -p .setup

OUTPUT_FILE=".setup/enabled-services.yaml"

# Check if config already exists
if [ -f "$OUTPUT_FILE" ]; then
  printf "âš ï¸  Configuration already exists at $OUTPUT_FILE. Overwrite? (y/n) "
  read REPLY
  case "$REPLY" in
    [Yy]|[Yy][Ee][Ss]) ;;
    *)
      echo "Keeping existing configuration."
      exit 0
      ;;
  esac
fi

echo "ðŸ“‹ Generating configuration for lightgbm-wine-classification example..."
echo "   This enables both Training and Inference presets:"
echo "   â€¢ Training (Compute + MLflow)"
echo "   â€¢ Inference (Serve + MLflow)"
echo ""

# Generate the enabled-services.yaml
cat > "$OUTPUT_FILE" << 'EOF'
# Darwin Distribution - Enabled Services Configuration
# Generated by examples/lightgbm-wine-classification/init-example.sh on $(date)
#
# Legend:
#   (direct)     - Directly selected by user
#   (dependency) - Auto-enabled due to dependencies

applications:
  darwin-ofs-v2: false
  darwin-ofs-v2-admin: false
  darwin-ofs-v2-consumer: false
  darwin-mlflow: true  # (direct)
  darwin-mlflow-app: true  # (direct)
  chronos: false
  chronos-consumer: false
  darwin-compute: true  # (direct)
  darwin-cluster-manager: true  # (dependency)
  darwin-workspace: false
  ml-serve-app: true  # (direct)
  artifact-builder: true  # (dependency)
  darwin-workflow: false
  darwin-catalog: false

ray-images:
  "ray:2.37.0": true  # (selected)
  "ray:2.53.0": false

serve-images:
  "serve-md-runtime:latest": true  # (auto-enabled with ml-serve-app)

datastores:
  mysql: true
  cassandra: false
  kafka: false
  zookeeper: false
  airflow: false
  rabbitmq: false
  localstack: true
  opensearch: true
  elasticsearch: false
  busybox: true

darwin-sdk-runtime:
  enabled: true

cli-tools:
  darwin-cli: true
EOF

echo "âœ… Configuration saved to: $OUTPUT_FILE"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "                        CONFIGURATION SAVED"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Enabled services:"
echo ""
echo "ðŸ“¦ Applications:"
echo "   âœ“ darwin-compute (direct)"
echo "   âœ“ darwin-cluster-manager (dependency)"
echo "   âœ“ darwin-mlflow (direct)"
echo "   âœ“ darwin-mlflow-app (direct)"
echo "   âœ“ ml-serve-app (direct)"
echo "   âœ“ artifact-builder (dependency)"
echo ""
echo "ðŸ”· Ray Images (selected):"
echo "   âœ“ ray:2.37.0"
echo ""
echo "ðŸš€ Serve Images (auto-enabled with ml-serve-app):"
echo "   âœ“ serve-md-runtime:latest"
echo ""
echo "ðŸ—„ï¸  Datastores:"
echo "   âœ“ mysql"
echo "   âœ“ localstack"
echo "   âœ“ opensearch"
echo "   âœ“ busybox"
echo ""
echo "ðŸ› ï¸  CLI Tools:"
echo "   âœ“ darwin-cli"
echo ""
echo "ðŸ”· Darwin SDK Runtime:"
echo "   âœ“ ray:2.37.0-darwin-sdk (Ray + Spark + Darwin SDK)"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "                        DEPENDENCY SUMMARY"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Features selected by user:"
echo "   â€¢ Compute"
echo "   â€¢ MLflow"
echo "   â€¢ Serve"
echo ""
echo "Services auto-enabled as dependencies:"
echo "   â†’ darwin-cluster-manager"
echo "   â†’ artifact-builder"
echo ""
echo "Next steps:"
echo "  1. Run ./setup.sh to build images and set up the cluster"
echo "  2. Run ./start.sh to deploy the platform"
echo ""
