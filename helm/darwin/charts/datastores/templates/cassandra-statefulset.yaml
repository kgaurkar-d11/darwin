{{- if .Values.cassandra.enabled }}
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ .Release.Name }}-cassandra
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "darwin.labels" . | nindent 4 }}
    app.kubernetes.io/component: cassandra
spec:
  serviceName: {{ .Release.Name }}-cassandra-headless
  replicas: {{ .Values.cassandra.cluster.replicaCount }}
  selector:
    matchLabels:
      {{- include "darwin.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: cassandra
  template:
    metadata:
      labels:
        {{- include "darwin.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: cassandra
    spec:
      containers:
        - name: cassandra
          image: cassandra:5.0
          env:
            - name: MAX_HEAP_SIZE
              value: "512M"
            - name: HEAP_NEWSIZE
              value: "256M"
            - name: CASSANDRA_CLUSTER_NAME
              value: {{ .Values.cassandra.cluster.name | quote }}
            - name: CASSANDRA_DC
              value: "datacenter1"
            - name: CASSANDRA_RACK
              value: "rack1"
            - name: CASSANDRA_SEEDS
              value: "{{ .Release.Name }}-cassandra-0.{{ .Release.Name }}-cassandra-headless.{{ .Values.global.namespace }}.svc.cluster.local"
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          ports:
            - name: intra-node
              containerPort: 7000
            - name: tls-intra-node
              containerPort: 7001
            - name: jmx
              containerPort: 7199
            - name: cql
              containerPort: 9042
          livenessProbe:
            exec:
              command:
                - /bin/bash
                - -c
                - nodetool status
            initialDelaySeconds: 30
            periodSeconds: 15
            timeoutSeconds: 8
            failureThreshold: 3
          readinessProbe:
            exec:
              command:
                - /bin/bash
                - -c
                - nodetool status | grep UN
            initialDelaySeconds: 20
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 5
          resources:
            {{- toYaml .Values.cassandra.resources | nindent 12 }}
          {{- if .Values.cassandra.persistence.enabled }}
          volumeMounts:
            - name: data
              mountPath: /var/lib/cassandra
              {{- if index .Values.global "local-k8s" }}
              subPathExpr: $(POD_NAME)
              {{- end }}
          {{- end }}
      {{- if and .Values.cassandra.persistence.enabled (index .Values.global "local-k8s") }}
      initContainers:
        - name: create-data-dir
          image: busybox:1.36
          command: ['sh', '-c', 'mkdir -p /data/$(POD_NAME) && chown -R 999:999 /data/$(POD_NAME)']
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          volumeMounts:
            - name: data
              mountPath: /data
      volumes:
        - name: data
          hostPath:
            path: /mnt/shared-data/cassandra
            type: DirectoryOrCreate
      {{- end }}
  {{- if and .Values.cassandra.persistence.enabled (not (index .Values.global "local-k8s")) }}
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: [ "ReadWriteOnce" ]
        {{- if .Values.global.storageClass }}
        storageClassName: {{ .Values.global.storageClass }}
        {{- end }}
        resources:
          requests:
            storage: {{ .Values.cassandra.persistence.size }}
  {{- end }}
{{- end }}
