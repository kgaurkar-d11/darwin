name: Darwin Workflow - Linting

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'darwin-workflow/**'
      - '.github/workflows/darwin-workflow-lint.yml'
jobs:
  lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: darwin-workflow

    strategy:
      matrix:
        module:
          - app_layer
          - core
          - model
          - sdk
          - airflow

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8==6.0.0 mypy==1.3.0

      - name: Install module dependencies
        run: |
          echo "Installing dependencies for ${{ matrix.module }}..."
          # For linting, we only need dev dependencies (flake8, mypy are already installed)
          # Skip requirements.txt as it may contain relative path dependencies (-e ../core)
          # that aren't needed for static analysis
          if [ -f "${{ matrix.module }}/requirements_dev.txt" ]; then
            pip install -r ${{ matrix.module }}/requirements_dev.txt
          fi
          echo "✅ Dependencies installed (skipping requirements.txt for linting)"

      - name: Run flake8
        run: |
          if [ -d "${{ matrix.module }}/src" ]; then
            echo "Running flake8 on ${{ matrix.module }}/src..."
            # Only check for critical errors: undefined names (F821) and syntax errors (E9)
            # Ignore style issues: whitespace, blank lines, unused imports, line length, spacing, unused variables
            # Exclude template files (they have variables like dag_config defined at runtime)
            flake8 --max-line-length=160 \
              --extend-ignore=E203,W503,W293,W291,W292,W391,F401,E501,E231,E302,E303,E305,E251,E252,E127,E128,E131,E122,E114,E117,E265,E266,E402,E722,E741,E731,F841,F811,F541,F403 \
              --select=F821,E9 \
              --exclude='*/templates/*,*/artefact_template.py' \
              ${{ matrix.module }}/src
            echo "✅ flake8 passed for ${{ matrix.module }} (critical errors only)"
          else
            echo "⚠️  No src directory found in ${{ matrix.module }}, skipping flake8"
          fi

      - name: Run mypy
        run: |
          if [ -d "${{ matrix.module }}/src" ]; then
            echo "Running mypy on ${{ matrix.module }}/src..."
            mypy ${{ matrix.module }}/src --ignore-missing-imports --no-strict-optional || true
            echo "✅ mypy completed for ${{ matrix.module }}"
          else
            echo "⚠️  No src directory found in ${{ matrix.module }}, skipping mypy"
          fi
        continue-on-error: true

