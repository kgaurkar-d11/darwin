#!/bin/sh
# =============================================================================
# Iris Classification Spark Example - Quick Setup Script
# =============================================================================
# This script creates the required configuration for the iris classification
# end-to-end example. It generates .setup/enabled-services.yaml with:
#   - Compute (darwin-compute, darwin-cluster-manager)
#   - MLflow (darwin-mlflow, darwin-mlflow-app)
#   - Serve (ml-serve-app, artifact-builder)
#   - Ray image: ray:2.37.0
#   - Darwin SDK Runtime (Ray + Spark support)
#   - Darwin CLI
# =============================================================================

set -e

# Navigate to project root
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
cd "$PROJECT_ROOT"

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘     Iris Classification Spark Example - Quick Setup            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Project root: $PROJECT_ROOT"
echo ""

# Check if yq is available
if ! command -v yq >/dev/null 2>&1; then
  echo "âŒ yq is required but not installed."
  echo "   Please run setup.sh first to install dependencies, or install yq manually."
  exit 1
fi

# Create .setup directory if it doesn't exist
mkdir -p .setup

OUTPUT_FILE=".setup/enabled-services.yaml"

# Check if config already exists
if [ -f "$OUTPUT_FILE" ]; then
  printf "âš ï¸  Configuration already exists at $OUTPUT_FILE. Overwrite? (y/n) "
  read REPLY
  case "$REPLY" in
    [Yy]|[Yy][Ee][Ss]) ;;
    *)
      echo "Keeping existing configuration."
      exit 0
      ;;
  esac
fi

echo "ðŸ“‹ Generating configuration for iris-classification example..."
echo ""

# Generate the enabled-services.yaml
cat > "$OUTPUT_FILE" << 'EOF'
# Darwin Distribution - Enabled Services Configuration
# Generated by examples/iris-classification/init-example.sh
#
# This configuration enables the services required for the
# iris classification Spark end-to-end example:
#   - Compute cluster management
#   - MLflow for experiment tracking and model registry
#   - ML-Serve for model deployment
#   - Darwin SDK Runtime for Spark support

applications:
  darwin-ofs-v2: false
  darwin-ofs-v2-admin: false
  darwin-ofs-v2-consumer: false
  darwin-mlflow: true  # (direct) - MLflow tracking server
  darwin-mlflow-app: true  # (direct) - MLflow application
  chronos: false
  chronos-consumer: false
  darwin-compute: true  # (direct) - Compute cluster management
  darwin-cluster-manager: true  # (dependency) - Required by darwin-compute
  darwin-workspace: false
  ml-serve-app: true  # (direct) - Model serving
  artifact-builder: true  # (dependency) - Required by ml-serve-app
  darwin-workflow: false
  darwin-catalog: false

ray-images:
  "ray:2.37.0": true  # (selected) - Base Ray runtime
  "ray:2.53.0": false

serve-images:
  "serve-md-runtime:latest": true  # (auto-enabled with ml-serve-app)

datastores:
  mysql: true  # Required by compute, mlflow, serve
  cassandra: false
  kafka: false
  zookeeper: false
  airflow: false
  rabbitmq: false
  localstack: true  # Required for S3-compatible storage
  opensearch: true  # Required by compute
  elasticsearch: false
  busybox: true  # Init container

darwin-sdk-runtime:
  enabled: true  # Ray + Spark + Darwin SDK

cli-tools:
  darwin-cli: true  # CLI for cluster and serve management
EOF

echo "âœ… Configuration saved to: $OUTPUT_FILE"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "                     ENABLED SERVICES"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ðŸ“¦ Applications:"
echo "   âœ“ darwin-compute (direct)"
echo "   âœ“ darwin-cluster-manager (dependency)"
echo "   âœ“ darwin-mlflow (direct)"
echo "   âœ“ darwin-mlflow-app (direct)"
echo "   âœ“ ml-serve-app (direct)"
echo "   âœ“ artifact-builder (dependency)"
echo ""
echo "ðŸ”· Ray Images:"
echo "   âœ“ ray:2.37.0"
echo ""
echo "ðŸ”· Darwin SDK Runtime:"
echo "   âœ“ ray:2.37.0-darwin-sdk (Ray + Spark + Darwin SDK)"
echo ""
echo "ðŸš€ Serve Images:"
echo "   âœ“ serve-md-runtime:latest"
echo ""
echo "ðŸ—„ï¸  Datastores:"
echo "   âœ“ mysql"
echo "   âœ“ localstack"
echo "   âœ“ opensearch"
echo "   âœ“ busybox"
echo ""
echo "ðŸ› ï¸  CLI Tools:"
echo "   âœ“ darwin-cli"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "                        NEXT STEPS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "  1. Build images and setup cluster:"
echo "     ./setup.sh -y"
echo ""
echo "  2. Deploy the platform:"
echo "     ./start.sh"
echo ""
echo "  3. Follow the example guide:"
echo "     See examples/iris-classification/README.md"
echo ""
