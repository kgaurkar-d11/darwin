package darwincatalog.util;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.junit.jupiter.api.Assertions.assertTrue;

import darwincatalog.exception.InvalidSqlException;
import java.util.Arrays;
import java.util.HashSet;
import java.util.Set;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

class SqlParserTest {
  SqlParser sqlParser = new SqlParser();

  @Test
  @DisplayName(
      "getTableNames should extract table names from complex query with subqueries, joins and aggregations 1")
  void testGetTableNames1() {
    String query =
        "Select * from ( Select a.d1 as activity_date, a.userid, a.roundid, overlays_size, cea, Joined_ContestAmount as joined_contestamount, Joined_ServiceFee as joined_servicefee, Refunded5 as refunded5, Refunded5_ContestAmount as refunded5_contestamount, Refunded5_ServiceFee as refunded5_servicefee, Refunded49 as refunded49, Refunded49_ContestAmount as refunded49_contestamount, Refunded49_ServiceFee as refunded49_servicefee, winnings, CashBonusBalanceSum as cashbonusbalancesum, DepositBalanceSum as depositbalancesum, WinningsBalanceSum as winningsbalancesum, overlays_ruser, overlays_duser, ceatxns, COALESCE(b.Transtype28_DepositBonusRetentionUtilised, 0) AS transtype28_depositbonusretentionutilised, COALESCE(b.Transtype47_LevelUpRetentionUtilised, 0) AS transtype47_levelupretentionutilised, COALESCE(b.Transtype53_HotstarUtilised, 0) AS transtype53_hotstarutilised, COALESCE(b.Transtype54_CouponUtilised, 0) AS transtype54_couponutilised, COALESCE(b.CouponUtilised_referralcost, 0) AS couponutilised_referralcost, COALESCE(b.CouponUtilised_acquisitioncost, 0) AS couponutilised_acquisitioncost, COALESCE(b.ReferralCashBonusUtilised, 0) AS referralcashbonusutilised, CASE WHEN d1 < DATE( '2023-10-01' ) THEN COALESCE(b.OtherCashBonusUtilised, 0) ELSE 0 END AS othercashbonusutilised, COALESCE(b.Transtype57_OfferAppSignupBonusUtilised, 0) AS transtype57_offerappsignupbonusutilised, COALESCE(b.Transtype58_LoyaltyDepositBonusUtilised, 0) AS transtype58_loyaltydepositbonusutilised, COALESCE(b.Transtype59_OrganicSignupBonusUtilised, 0) AS transtype59_organicsignupbonusutilised, CASE WHEN d1 < DATE( '2023-10-01' ) THEN COALESCE(b.Transtype60_SameTeamRefundCBUtilised, 0) ELSE 0 END AS transtype60_sameteamrefundcbutilised, COALESCE(b.Transtype61_FirstDepositCBGiven, 0) AS transtype61_firstdepositcbgiven, COALESCE(b.Transtype62_ContestCreatorCBUtilised, 0) AS transtype62_contestcreatorcbutilised, COALESCE(b.Transtype64_gamificationCBUtilised, 0) AS transtype64_gamificationcbutilised, COALESCE(b.Transtype32_rewardsshopCBUtilised, 0) AS transtype32_rewardsshopcbutilised, COALESCE(b.Transtype28_DepositBonusRetentionUtilised_ref, 0) AS transtype28_depositbonusretentionutilised_ref, COALESCE(b.Transtype47_LevelUpRetentionUtilised_ref, 0) AS transtype47_levelupretentionutilised_ref, COALESCE(b.Transtype53_HotstarUtilised_ref, 0) AS transtype53_hotstarutilised_ref, COALESCE(b.Transtype54_CouponUtilised_ref, 0) AS transtype54_couponutilised_ref, COALESCE(b.CouponUtilised_referralcost_ref, 0) AS couponutilised_referralcost_ref, COALESCE(b.CouponUtilised_acquisitioncost_ref, 0) AS couponutilised_acquisitioncost_ref, COALESCE(b.ReferralCashBonusUtilised_ref, 0) AS referralcashbonusutilised_ref, CASE WHEN d1 < DATE( '2023-10-01' ) THEN COALESCE(b.OtherCashBonusUtilised_ref, 0) ELSE 0 END AS othercashbonusutilised_ref, COALESCE(b.Transtype57_OfferAppSignupBonusUtilised_ref, 0) AS transtype57_offerappsignupbonusutilised_ref, COALESCE(b.Transtype58_LoyaltyDepositBonusUtilised_ref, 0) AS transtype58_loyaltydepositbonusutilised_ref, COALESCE(b.Transtype59_OrganicSignupBonusUtilised_ref, 0) AS transtype59_organicsignupbonusutilised_ref, CASE WHEN d1 < DATE( '2023-10-01' ) THEN COALESCE(b.Transtype60_SameTeamRefundCBUtilised_ref, 0) ELSE 0 END AS transtype60_sameteamrefundcbutilised_ref, COALESCE(b.Transtype61_FirstDepositCBGiven_ref, 0) AS transtype61_firstdepositcbgiven_ref, COALESCE(b.Transtype62_ContestCreatorCBUtilised_ref, 0) AS transtype62_contestcreatorcbutilised_ref, COALESCE(b.Transtype64_gamificationCBUtilised_ref, 0) AS transtype64_gamificationcbutilised_ref, COALESCE(b.Transtype32_rewardsshopCBUtilised_ref, 0) AS transtype32_rewardsshopcbutilised_ref, CASE WHEN d1 < DATE( '2023-10-01' ) THEN COALESCE(b.totalcbutilised_ref, 0) ELSE 0 END AS totalcbutilised_ref, CASE WHEN d1 >= DATE( '2023-10-01' ) THEN (Joined_ServiceFee - Refunded5_ServiceFee - Refunded49_ServiceFee) ELSE (Joined_ServiceFee - Refunded5_ServiceFee - Refunded49_ServiceFee) / 1.18 END AS ggr, (CashBonusBalanceSum) AS netcbuti, CASE WHEN d1 < DATE( '2023-10-01' ) THEN COALESCE(b.totalcbutilised_ref, 0) ELSE 0 END AS netcbuti_ref, CURRENT_TIMESTAMP AS load_date, WinnerAdj7 AS winneradj7, COALESCE(b.Transtype83_shieldCBUtilised, 0) AS transtype83_shieldcbutilised, COALESCE(b.Transtype83_shieldCBUtilised_ref, 0) AS transtype83_shieldcbutilised_ref, DiscountBonusBalanceSum AS discountbonusbalancesum, DiscountPointBalanceSum AS discountpointbalancesum, COALESCE(a.DiscountPointBalanceRefundSum, 0) AS discountpointbalancesum_ref, COALESCE(b.Transtype106_DepositBonusRetentionUtilised, 0) AS transtype106_depositbonusretentionutilised, COALESCE(b.Transtype109_CouponUtilised, 0) AS transtype109_couponutilised, COALESCE(b.ReferralDiscountBonusUtilised, 0) AS referraldiscountbonusutilised, CASE WHEN d1 >= DATE( '2023-10-01' ) THEN COALESCE(b.OtherDiscountBonusUtilised, 0) ELSE 0 END AS otherdiscountbonusutilised, CASE WHEN d1 >= DATE( '2023-10-01' ) THEN COALESCE(b.Transtype114_SameTeamRefundDBBUtilised, 0) ELSE 0 END AS transtype114_sameteamrefunddbbutilised, COALESCE(b.Transtype111_FirstDepositDBBGiven, 0) AS transtype111_firstdepositdbbgiven, COALESCE(b.Transtype107_rewardsshopDBBUtilised, 0) AS transtype107_rewardsshopdbbutilised, COALESCE(b.Transtype106_DepositBonusRetentionUtilised_ref, 0) AS transtype106_depositbonusretentionutilised_ref, COALESCE(b.Transtype109_CouponUtilised_ref, 0) AS transtype109_couponutilised_ref, COALESCE(b.ReferralDiscountBonusUtilised_ref, 0) AS referraldiscountbonusutilised_ref, CASE WHEN d1 >= DATE( '2023-10-01' ) THEN COALESCE(b.OtherDiscountBonusUtilised_ref, 0) ELSE 0 END AS otherdiscountbonusutilised_ref, CASE WHEN d1 >= DATE( '2023-10-01' ) THEN COALESCE(b.Transtype114_SameTeamRefundDBBUtilised_ref, 0) ELSE 0 END AS transtype114_sameteamrefunddbbutilised_ref, COALESCE(b.Transtype111_FirstDepositDBBGiven_ref, 0) AS transtype111_firstdepositdbbgiven_ref, COALESCE(b.Transtype107_rewardsshopDBBUtilised_ref, 0) AS transtype107_rewardsshopdbbutilised_ref, CASE WHEN d1 >= DATE( '2023-10-01' ) THEN COALESCE(b.totalcbutilised_ref, 0) ELSE 0 END AS totaldbbutilised_ref, (DiscountBonusBalanceSum) AS netdbbuti, DiscountBonusBalanceRefundSum as netdbbuti_ref, COALESCE(b.Transtype112_shieldDBBUtilised, 0) AS transtype112_shielddbbutilised, COALESCE(b.Transtype112_shieldDBBUtilised_ref, 0) AS transtype112_shielddbbutilised_ref, PlayWinningsBalanceSum as PlayWinningsBalanceSum, COALESCE(b.Transtype121_playwinningsDBBUtilised, 0) AS Transtype121_playwinningsDBBUtilised, COALESCE(b.Transtype121_playwinningsDBBUtilised_ref, 0) AS Transtype121_playwinningsDBBUtilised_ref, DreamCoinBalanceSum as dreamcoinbalancesum, PromoDiscountBalanceSum as promodiscountbalancesum, PromoDiscountBalanceRefundSum as netpdb_ref, DreamCoinBalanceRefundSum as ntdc_ref, COALESCE(EarlyWinningsAwarded, 0) AS EarlyWinningsAwarded, COALESCE(EarlyWinningsAdjusted, 0) AS EarlyWinningsAdjusted FROM (SELECT a.d1, a.userid, a.roundid, COALESCE(overlays_size, 0) AS overlays_size, COALESCE(SUM(cea), 0) AS cea, COALESCE(SUM(Joined_ContestAmount), 0) AS Joined_ContestAmount, COALESCE(SUM(Joined_ServiceFee), 0) AS Joined_ServiceFee, COALESCE(SUM(Refunded5), 0) AS Refunded5, COALESCE(SUM(Refunded5_ContestAmount), 0) AS Refunded5_ContestAmount, COALESCE(SUM(Refunded5_ServiceFee), 0) AS Refunded5_ServiceFee, COALESCE(SUM(Refunded49), 0) AS Refunded49, COALESCE(SUM(Refunded49_ContestAmount), 0) AS Refunded49_ContestAmount, COALESCE(SUM(Refunded49_ServiceFee), 0) AS Refunded49_ServiceFee, COALESCE(SUM(winnings), 0) AS winnings, COALESCE(SUM(DiscountBonusBalanceSum), 0) AS DiscountBonusBalanceSum, COALESCE(SUM(CashBonusBalanceSum), 0) AS CashBonusBalanceSum, COALESCE(SUM(DepositBalanceSum), 0) AS DepositBalanceSum, COALESCE(SUM(WinningsBalanceSum), 0) AS WinningsBalanceSum, COALESCE(SUM(DiscountPointBalanceSum), 0) AS DiscountPointBalanceSum, COALESCE(SUM(PlayWinningsBalanceSum), 0) AS PlayWinningsBalanceSum, COALESCE(SUM(DreamCoinBalanceSum), 0) AS DreamCoinBalanceSum, COALESCE(SUM(PromoDiscountBalanceSum), 0) AS PromoDiscountBalanceSum, COALESCE(SUM(overlay_txn), 0) AS overlays_ruser, COALESCE(b.overlays_size, 0) / COUNT(1) OVER (PARTITION BY d1) AS overlays_duser, COALESCE(SUM(ceatxns), 0) AS ceatxns, COALESCE(SUM(WinnerAdj7), 0) AS WinnerAdj7, COALESCE(SUM(DiscountBonusBalanceRefundSum), 0) AS DiscountBonusBalanceRefundSum, COALESCE(SUM(PromoDiscountBalanceRefundSum), 0) AS PromoDiscountBalanceRefundSum, COALESCE(SUM(DreamCoinBalanceRefundSum), 0) AS DreamCoinBalanceRefundSum, COALESCE(SUM(DiscountPointBalanceRefundSum), 0) AS DiscountPointBalanceRefundSum, COALESCE(SUM(EarlyWinningsAwarded), 0) AS EarlyWinningsAwarded, COALESCE(SUM(EarlyWinningsAdjusted), 0) AS EarlyWinningsAdjusted FROM (SELECT DATE(a.createdat + (INTERVAL '5' hour + INTERVAL '30' minute)) AS d1, a.userid, a.roundid, a.leagueid, COALESCE(SUM(CASE WHEN a.TransType IN (1) THEN (a.amount) ELSE 0 END), 0) AS CEA, COALESCE(SUM(CASE WHEN a.TransType IN (1) THEN (b.ContestAmount * a.amount) ELSE 0 END), 0) AS Joined_ContestAmount, COALESCE(SUM(CASE WHEN a.TransType IN (1) THEN (b.ServiceFee * a.amount) ELSE 0 END), 0) AS Joined_ServiceFee, COALESCE(SUM(CASE WHEN a.TransType IN (5) THEN (a.amount) ELSE 0 END), 0) AS Refunded5, COALESCE(SUM(CASE WHEN a.TransType IN (5) THEN (b.ContestAmount * a.amount) ELSE 0 END), 0) AS Refunded5_ContestAmount, COALESCE(SUM(CASE WHEN a.TransType IN (5) THEN (b.ServiceFee * a.amount) ELSE 0 END), 0) AS Refunded5_ServiceFee, COALESCE(SUM(CASE WHEN a.TransType IN (49) THEN (a.amount) ELSE 0 END), 0) AS Refunded49, COALESCE(SUM(CASE WHEN a.TransType IN (49) THEN (b.ContestAmount * a.amount) ELSE 0 END), 0) AS Refunded49_ContestAmount, COALESCE(SUM(CASE WHEN a.TransType IN (49) THEN (b.ServiceFee * a.amount) ELSE 0 END), 0) AS Refunded49_ServiceFee, COALESCE(SUM(CASE WHEN a.TransType IN (3) THEN (a.amount) ELSE 0 END), 0) AS winnings, (COALESCE(SUM(CASE WHEN a.transtype IN (1) THEN COALESCE(c.CashBonusBalance, a.cash_bonus_balance) ELSE 0 END), 0)) AS CashBonusBalanceSum, (COALESCE(SUM(CASE WHEN a.transtype IN (1) THEN COALESCE(c.DiscountBonusBalance, a.discount_bonus_balance) ELSE 0 END), 0)) AS DiscountBonusBalanceSum, COALESCE(SUM(CASE WHEN a.transtype IN (1) THEN COALESCE(c.WinningsBalance, a.winning_balance) ELSE 0 END), 0) AS WinningsBalanceSum, COALESCE(SUM(CASE WHEN a.transtype IN (1) THEN COALESCE(c.DepositBalance, a.deposit_balance) ELSE 0 END), 0) AS DepositBalanceSum, COALESCE(SUM(CASE WHEN a.transtype IN (1) THEN COALESCE(c.DiscountBalance, a.discount_balance) ELSE 0 END), 0) AS DiscountPointBalanceSum, COALESCE(SUM(CASE WHEN a.transtype IN (1) THEN COALESCE(c.PlayWinningsBalance, a.PLAY_WINNING_BALANCE) ELSE 0 END), 0) AS PlayWinningsBalanceSum, COALESCE(SUM(CASE WHEN a.transtype IN (1) THEN a.dreamcoinbalanceinr ELSE 0 END), 0) AS DreamCoinBalanceSum, COALESCE(SUM(CASE WHEN a.transtype IN (1) THEN a.promo_discount_balance ELSE 0 END), 0) AS PromoDiscountBalanceSum, COALESCE(SUM(CASE WHEN a.transtype = 1 THEN a.amount / b.entryfee END), 0) AS ceatxns, COALESCE(SUM(CASE WHEN a.transtype = 1 THEN d.Overlays_txn * (a.amount / b.entryfee) END), 0) AS overlay_txn, COUNT(1) AS uwtxns, COALESCE(SUM(CASE WHEN a.TransType IN (7) THEN (a.amount) ELSE 0 END), 0) AS WinnerAdj7, COALESCE(SUM(CASE WHEN a.TransType IN (5,49) THEN (coalesce(a.discount_bonus_balance,0)) ELSE 0 END), 0) AS DiscountBonusBalanceRefundSum, COALESCE(SUM(CASE WHEN a.TransType IN (5,49) THEN (coalesce(a.promo_discount_balance,0)) ELSE 0 END), 0) AS PromoDiscountBalanceRefundSum, COALESCE(SUM(CASE WHEN a.TransType IN (5,49) THEN (coalesce(a.dreamcoinbalanceinr,0)) ELSE 0 END), 0) AS DreamCoinBalanceRefundSum, COALESCE(SUM(CASE WHEN a.transtype IN (5,49) THEN (coalesce(a.discount_balance,0)) ELSE 0 END), 0) AS DiscountPointBalanceRefundSum, COALESCE(SUM(CASE WHEN a.TransType IN (2003) THEN (a.amount) ELSE 0 END), 0) AS EarlyWinningsAwarded, COALESCE(SUM(CASE WHEN a.TransType IN (2004) THEN (a.amount) ELSE 0 END), 0) AS EarlyWinningsAdjusted FROM (select id, transactionid, userid, createdat, transtype, roundid, wlsid, leagueid, amount, winning_balance, deposit_balance, discount_balance, discount_bonus_balance, cash_bonus_balance, play_winning_balance, dreamcoinbalanceinr, promo_discount_balance from company_stitch.example_uwtransactions_recreated where (transtype in (1, 3, 7, 49, 2003, 2004) or (transtype = 5 and leagueid != 0)) AND date(createdat + interval '330' minute) >= date(date_parse('2025-02-13', '%Y-%m-%d') - interval '1' day) and date(createdat + interval '330' minute) <= date(('2025-02-13' )) union all (select a.id, a.transactionid, a.userid, a.createdat, a.transtype, a.roundid, b.wlsid, b.leagueid, b.amount, b.winning_balance, b.deposit_balance, b.discount_balance, b.discount_bonus_balance, b.cash_bonus_balance, b.play_winning_balance, b.dreamcoinbalanceinr, b.promo_discount_balance from (select * from company_stitch.example_uwtransactions_recreated a where date(createdat + interval '330' minute) >= date(date_parse('2025-02-13', '%Y-%m-%d') - interval '1' day) and date(createdat + interval '330' minute) <= date(('2025-02-13' )) and transtype = 5 and leagueid = 0) a left join (select * from company_stitch.example_uwtransactions_recreated where date(createdat + interval '330' minute) >= date(date_parse('2025-02-13', '%Y-%m-%d') - interval '11' day) and date(createdat + interval '330' minute) <= date(('2025-02-13' )) and transtype =1 and leagueid not in (select leagueid from company_stitch.example_uwtransactions_recreated where date(createdat + interval '330' minute) >= date(date_parse('2025-02-13', '%Y-%m-%d') - interval '11' day) and date(createdat + interval '330' minute) <= date(('2025-02-13' )) and transtype=5 and leagueid !=0 and leagueid is not null) and idempotency_key not in (select idempotency_key from company_stitch.example_uwtransactions_recreated where date(createdat + interval '330' minute) >= date(date_parse('2025-02-13', '%Y-%m-%d') - interval '11' day) and date(createdat + interval '330' minute) <= date(('2025-02-13' )) and transtype=49 and idempotency_key is not null) ) b on a.userid = b.userid and a.roundid = b.roundid)) AS a LEFT JOIN (SELECT roundid, Contestid, entryfee, WLSID, (ContestAmount / entryfee) AS ContestAmount, (ServiceFee / entryfee) AS servicefee FROM company_transactions.example_contestwlsrelation WHERE wlsid IN (SELECT DISTINCT id FROM company_transactions.example_wlsdetails as c WHERE c.WLSCurrency = 'INR')) AS b ON a.leagueid = b.Contestid AND a.WLSId = b.WLSId AND a.roundid = b.roundid LEFT JOIN (SELECT * FROM company_transactions.example_contestuserbreakup WHERE DATE(createdat + (INTERVAL '5' hour + INTERVAL '30' minute )) <= CAST('2023-12-31' AS DATE)) AS c ON a.id = c.uwtransactionid LEFT JOIN (SELECT a.TourId, a.RoundId, a.id AS ContestId, a.createdat AS Startdatetime, (c.RoundStartTime + (INTERVAL '5' hour + INTERVAL '30' minute)) AS RoundStartTime, (c.WinnerAnnouncedDate + (INTERVAL '5' hour + INTERVAL '30' minute)) AS WinnerAnnouncedtime, DATE(c.WinnerAnnouncedDate + (INTERVAL '5' hour + INTERVAL '30' minute)) AS WinnerAnnouncedDate, a.CurrentSize, a.ContestSize, a.ActualContestSize, a.PrizeAmount, a.EntryFee - ROUND((((ActualContestSize * a.EntryFee) - a.PrizeAmount) / ActualContestSize), 2) AS ContestAmount, a.EntryFee, SUM(b.AmountWonINR) AS AmountINR, SUM(b.AmountWonINRAfterTax) AS AmountINRAfterTax, ROUND(((a.ActualContestSize - a.CurrentSize) * (a.EntryFee - ROUND((((a.ActualContestSize * a.EntryFee) - a.PrizeAmount) / a.ActualContestSize), 2)) - (a.PrizeAmount - SUM(b.AmountWonINR))), 2) AS Overlays, ROUND(((a.ActualContestSize - a.CurrentSize) * (a.EntryFee - ROUND((((a.ActualContestSize * a.EntryFee) - a.PrizeAmount) / a.ActualContestSize), 2)) - (a.PrizeAmount - SUM(b.AmountWonINR))), 2) / a.CurrentSize AS Overlays_txn FROM (select a.TourId, a.RoundId, a.id, a.CurrentSize, a.EntryFee, a.behaviour, a.contesttype, a.Isguaranteed, a.PrizeAmount, a.guaranteedprizeamount, a.prizestepamount, case when a.behaviour='guaranteed_plus' and a.prizestepamount!=0 then FLOOR(a.PrizeAmount/(round((a.entryfee-b.servicefee),2))) else a.ActualContestSize end as ActualContestSize, a.ContestSize, a.createdat from company_transactions.example_contestmaster a left join company_transactions.example_contestwlsrelation b on a.id=b.contestId) as a INNER JOIN company_transactions.example_contestuserdetails as b ON a.id = b.leagueid AND a.roundid = b.roundid AND a.ActualContestSize > a.CurrentSize AND a.EntryFee > 0 AND b.WLSId IN (SELECT id FROM company_transactions.example_wlsdetails WHERE WlsCurrency = 'INR') AND AmountWonINR > 0 INNER JOIN company_transactions.example_roundmaster as c ON a.RoundId = c.id AND c.RoundCalcStatus = 3 WHERE (LOWER(a.contesttype) LIKE LOWER('special') OR LOWER(a.contesttype) LIKE LOWER('grand') OR LOWER(a.contesttype) LIKE LOWER('public')) AND ((CASE WHEN ((((a.ActualContestSize BETWEEN 6 AND 10) AND (a.CurrentSize * 100 / a.ActualContestSize) >= 66 AND a.IsGuaranteed = 0 AND (a.behaviour IS NULL OR a.behaviour = 'legacy')) OR ((a.ActualContestSize >= 11) AND (a.CurrentSize * 100 / a.ActualContestSize) >= 75 AND a.IsGuaranteed = 0 AND (a.behaviour IS NULL OR a.behaviour = 'legacy'))) AND DATE(c.RoundStartTime + (INTERVAL '5' hour + INTERVAL '30' minute)) BETWEEN CAST( '2020-10-22' AS DATE) AND CAST('2023-02-03' AS DATE) ) OR (((a.ActualContestSize >= 6) AND (a.CurrentSize * 100 / a.ActualContestSize) >= 90 AND a.IsGuaranteed = 0 AND (a.behaviour IS NULL OR a.behaviour = 'legacy')) AND DATE(c.RoundStartTime + (INTERVAL '5' hour + INTERVAL '30' minute)) >= CAST(CAST('2023-02-04' AS DATE) AS DATE)) OR a.IsGuaranteed = 1 THEN 1 ELSE 0 END) = 1) GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13) AS d ON a.leagueid = d.contestid AND a.roundid = d.roundid AND a.transtype = 1 GROUP BY 1, 2, 3, 4) AS a LEFT JOIN (SELECT WinnerAnnouncedDate, SUM(Overlays) AS Overlays_size FROM (SELECT a.TourId, a.RoundId, a.id AS ContestId, a.createdat AS Startdatetime, (c.RoundStartTime + (INTERVAL '5' hour + INTERVAL '30' minute)) AS RoundStartTime, (c.WinnerAnnouncedDate + (INTERVAL '5' hour + INTERVAL '30' minute)) AS WinnerAnnouncedtime, DATE(c.WinnerAnnouncedDate + (INTERVAL '5' hour + INTERVAL '30' minute)) AS WinnerAnnouncedDate, a.CurrentSize, a.ContestSize, a.ActualContestSize, a.PrizeAmount, a.EntryFee - ROUND((((a.ActualContestSize * a.EntryFee) - a.PrizeAmount) / a.ActualContestSize), 2) AS ContestAmount, a.EntryFee, SUM(b.AmountWonINR) AS AmountINR, SUM(b.AmountWonINRAfterTax) AS AmountINRAfterTax, ROUND(((a.ActualContestSize - a.CurrentSize) * (a.EntryFee - ROUND((((a.ActualContestSize * a.EntryFee) - a.PrizeAmount) / a.ActualContestSize), 2)) - (a.PrizeAmount - SUM(b.AmountWonINR))), 2) AS Overlays FROM (select a.TourId, a.RoundId, a.id, a.CurrentSize, a.EntryFee, a.behaviour, a.contesttype, a.Isguaranteed, a.PrizeAmount, a.guaranteedprizeamount, a.prizestepamount, case when a.behaviour='guaranteed_plus' and a.prizestepamount!=0 then FLOOR(a.PrizeAmount/(round((a.entryfee-b.servicefee),2))) else a.ActualContestSize end as ActualContestSize, a.ContestSize, a.createdat from company_transactions.example_contestmaster a left join company_transactions.example_contestwlsrelation b on a.id=b.contestId) as a INNER JOIN company_transactions.example_contestuserdetails as b ON a.id = b.leagueid AND a.roundid = b.roundid AND a.ActualContestSize > a.CurrentSize AND a.EntryFee > 0 AND b.WLSId IN (SELECT id FROM company_transactions.example_wlsdetails WHERE WlsCurrency = 'INR') AND AmountWonINR > 0 INNER JOIN company_transactions.example_roundmaster as c ON a.RoundId = c.id AND c.RoundCalcStatus = 3 WHERE (LOWER(a.contesttype) LIKE LOWER('special') OR LOWER(a.contesttype) LIKE LOWER('grand') OR LOWER(a.contesttype) LIKE LOWER('public')) AND ((CASE WHEN ((((a.ActualContestSize BETWEEN 6 AND 10) AND (a.CurrentSize * 100 / a.ActualContestSize) >= 66 AND a.IsGuaranteed = 0 AND (a.behaviour IS NULL OR a.behaviour = 'legacy')) OR ((a.ActualContestSize >= 11) AND (a.CurrentSize * 100 / a.ActualContestSize) >= 75 AND a.IsGuaranteed = 0 AND (a.behaviour IS NULL OR a.behaviour = 'legacy'))) AND DATE(c.RoundStartTime + (INTERVAL '5' hour + INTERVAL '30' minute)) BETWEEN CAST( '2020-10-22' AS DATE) AND CAST('2023-02-03' AS DATE)) OR (((a.ActualContestSize >= 6) AND (a.CurrentSize * 100 / a.ActualContestSize) >= 90 AND a.IsGuaranteed = 0 AND (a.behaviour IS NULL OR a.behaviour = 'legacy')) AND DATE(c.RoundStartTime + (INTERVAL '5' hour + INTERVAL '30' minute)) >= CAST('2023-02-04' AS DATE)) OR a.IsGuaranteed = 1 THEN 1 ELSE 0 END) = 1) AND date(c.winnerannounceddate + (INTERVAL '5' hour + INTERVAL '30' minute)) >= date(date_parse('2025-02-13', '%Y-%m-%d') - interval '1' day) and date(c.winnerannounceddate + (INTERVAL '5' hour + INTERVAL '30' minute)) <= date(('2025-02-13' )) GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13) AS t GROUP BY 1) AS b ON a.d1 = b.WinnerAnnouncedDate GROUP BY 1, 2, 3, 4,b.overlays_size) AS a LEFT JOIN ( (SELECT DATE(a.actualeventtime + (INTERVAL '5' hour + INTERVAL '30' minute)) AS TxnDate, a.userid, a.roundid AS rcid, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type IN (106) THEN a.amount END), 0) AS Transtype106_DepositBonusRetentionUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type IN (28) THEN a.amount END), 0) AS Transtype28_DepositBonusRetentionUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type = 47 THEN a.amount END), 0) AS Transtype47_LevelUpRetentionUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type = 53 THEN a.amount END), 0) AS Transtype53_HotstarUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type IN (109) AND a.referralflag = 0 AND a.acquisitionflag = 0 THEN a.amount END), 0) AS Transtype109_CouponUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type IN (54) AND a.referralflag = 0 AND a.acquisitionflag = 0 THEN a.amount END), 0) AS Transtype54_CouponUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type IN (54, 109) AND a.referralflag = 1 AND a.acquisitionflag = 0 THEN a.amount END), 0) AS CouponUtilised_referralcost, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type IN (54, 109) AND a.referralflag = 0 AND a.acquisitionflag = 1 THEN a.amount END), 0) AS CouponUtilised_acquisitioncost, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type IN (108) THEN a.amount END), 0) AS ReferralDiscountBonusUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type IN (20, 21, 22, 23, 24, 25, 36, 37, 38) THEN a.amount END), 0) AS ReferralCashBonusUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type IN (104, 10, 12, 13, 14, 15, 26, 27, 40, 44, 50, 51, 52) THEN a.amount END), 0) AS OtherDiscountBonusUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type IN (8, 10, 12, 13, 14, 15, 26, 27, 40, 44, 50, 51, 52) THEN a.amount END), 0) AS OtherCashBonusUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type = 57 THEN a.amount END), 0) AS Transtype57_OfferAppSignupBonusUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type = 58 THEN a.amount END), 0) AS Transtype58_LoyaltyDepositBonusUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type = 59 THEN a.amount END), 0) AS Transtype59_OrganicSignupBonusUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type = 114 THEN a.amount END), 0) AS Transtype114_SameTeamRefundDBBUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type = 60 THEN a.amount END), 0) AS Transtype60_SameTeamRefundCBUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type IN (111) THEN a.amount END), 0) AS Transtype111_FirstDepositDBBGiven, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type IN (61) THEN a.amount END), 0) AS Transtype61_FirstDepositCBGiven, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type = 62 THEN a.amount END), 0) AS Transtype62_ContestCreatorDBBUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type = 62 THEN a.amount END), 0) AS Transtype62_ContestCreatorCBUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type = 64 THEN a.amount END), 0) AS Transtype64_gamificationDBBUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type = 64 THEN a.amount END), 0) AS Transtype64_gamificationCBUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type IN (107) THEN a.amount END), 0) AS Transtype107_rewardsshopDBBUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type IN (32) THEN a.amount END), 0) AS Transtype32_rewardsshopCBUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type IN (112) THEN a.amount END), 0) AS Transtype112_shieldDBBUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type IN (83) THEN a.amount END), 0) AS Transtype83_shieldCBUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (1) AND a.balance_trans_type IN (121) THEN a.amount END), 0) AS Transtype121_playwinningsDBBUtilised, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) THEN a.amount END), 0) AS totalcbutilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type IN (106) THEN a.amount END), 0) AS Transtype106_DepositBonusRetentionUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type IN (28) THEN a.amount END), 0) AS Transtype28_DepositBonusRetentionUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type = 47 THEN a.amount END), 0) AS Transtype47_LevelUpRetentionUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type = 53 THEN a.amount END), 0) AS Transtype53_HotstarUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type IN (109) AND a.referralflag = 0 AND a.acquisitionflag = 0 THEN a.amount END), 0) AS Transtype109_CouponUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type IN (54) AND a.referralflag = 0 AND a.acquisitionflag = 0 THEN a.amount END), 0) AS Transtype54_CouponUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type IN (54, 109) AND a.referralflag = 1 AND a.acquisitionflag = 0 THEN a.amount END), 0) AS CouponUtilised_referralcost_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type IN (54, 109) AND a.referralflag = 0 AND a.acquisitionflag = 1 THEN a.amount END), 0) AS CouponUtilised_acquisitioncost_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type IN (108) THEN a.amount END), 0) AS ReferralDiscountBonusUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type IN (20, 21, 22, 23, 24, 25, 36, 37, 38) THEN a.amount END), 0) AS ReferralCashBonusUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type IN (104, 10, 12, 13, 14, 15, 26, 27, 40, 44, 50, 51, 52) THEN a.amount END), 0) AS OtherDiscountBonusUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type IN (8, 10, 12, 13, 14, 15, 26, 27, 40, 44, 50, 51, 52) THEN a.amount END), 0) AS OtherCashBonusUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type = 57 THEN a.amount END), 0) AS Transtype57_OfferAppSignupBonusUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type = 58 THEN a.amount END), 0) AS Transtype58_LoyaltyDepositBonusUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type = 59 THEN a.amount END), 0) AS Transtype59_OrganicSignupBonusUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type = 114 THEN a.amount END), 0) AS Transtype114_SameTeamRefundDBBUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type = 60 THEN a.amount END), 0) AS Transtype60_SameTeamRefundCBUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type IN (111) THEN a.amount END), 0) AS Transtype111_FirstDepositDBBGiven_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type IN (61) THEN a.amount END), 0) AS Transtype61_FirstDepositCBGiven_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type = 62 THEN a.amount END), 0) AS Transtype62_ContestCreatorCBUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type = 64 THEN a.amount END), 0) AS Transtype64_gamificationCBUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type IN (107) THEN a.amount END), 0) AS Transtype107_rewardsshopDBBUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type IN (32) THEN a.amount END), 0) AS Transtype32_rewardsshopCBUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type IN (112) THEN a.amount END), 0) AS Transtype112_shieldDBBUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type IN (83) THEN a.amount END), 0) AS Transtype83_shieldCBUtilised_ref, COALESCE(SUM(CASE WHEN a.transtype IN (5, 49) AND a.balance_trans_type IN (121) THEN a.amount END), 0) AS Transtype121_playwinningsDBBUtilised_ref FROM (select actualeventtime, userid, roundid, transtype, balance_trans_type, referralflag, acquisitionflag, amount from company_aggregates.denorm_cashbonus_ledger_balance where DATE(actualeventtime + (INTERVAL '5' hour + INTERVAL '30' minute)) >= date(date_parse('2025-02-13', '%Y-%m-%d') - interval '1' day) and DATE(actualeventtime + (INTERVAL '5' hour + INTERVAL '30' minute)) <= date(('2025-02-13' )) union all select createdat as actualeventtime, userid, roundid, transaction_type as transtype, balance_trans_type as balance_trans_type, referralflag as referralflag, acquisitionflag as acquisitionflag, discount_currency_amount from company_stitch.denorm_cashbonus_ledger_balance_new where DATE(createdat + (INTERVAL '5' hour + INTERVAL '30' minute)) >= date(date_parse('2025-02-13', '%Y-%m-%d') - interval '1' day) and DATE(createdat + (INTERVAL '5' hour + INTERVAL '30' minute)) <= date(('2025-02-13' )) ) as a JOIN company_transactions.example_roundmaster as c ON a.roundid = c.id WHERE a.transtype IN (1, 5, 49) GROUP BY 1, 2, 3) as a ) AS b ON a.userid = b.userid AND a.roundid = b.rcid AND a.d1 = b.TxnDate )";
    Set<String> result = sqlParser.getTableNames(query);
    System.out.println(result);

    Set<String> expected =
        new HashSet<>(
            Arrays.asList(
                "company_stitch.denorm_cashbonus_ledger_balance_new",
                "company_transactions.example_contestwlsrelation",
                "company_transactions.example_contestuserbreakup",
                "company_transactions.example_contestuserdetails",
                "company_aggregates.denorm_cashbonus_ledger_balance",
                "company_transactions.example_contestmaster",
                "company_transactions.example_roundmaster",
                "company_stitch.example_uwtransactions_recreated",
                "company_transactions.example_wlsdetails"));

    assertEquals(expected, new HashSet<>(result));
  }

  @Test
  @DisplayName(
      "getTableNames should extract table names from complex query with subqueries, joins and aggregations 2")
  void testGetTableNames2() {
    String query =
        "select a.*, case when cast(\"conviva_startup_time_ms\" as int) >= 0 then 'plays' else 'attempts' end as attempts_vs_plays, b.* from (select \"viewerid\" as \"conviva_viewerid\", \"asset\" as \"conviva_asset\", \"device/os\" as \"conviva_device/os\", \"country\" as \"conviva_country\", \"state\" as \"conviva_state\", \"city\" as \"conviva_city\", \"asn\" as \"conviva_asn\", \"isp\" as \"conviva_isp\", \"start time (unix time)\" as \"conviva_start_time_unix_time\", \"startup time (ms)\" as \"conviva_startup_time_ms\", \"playing time (ms)\" as \"conviva_playing_time_ms\", \"buffering time (ms)\" as \"conviva_buffering_time_ms\", \"interrupts\" as \"conviva_interrupts\", \"average bitrate (kbps)\" as \"conviva_average_bitrate_kbps\", \"startup error\" as \"conviva_startup_error\", \"fcVideoSessionId\" as \"conviva_fcVideoSessionId\", \"session tags\" as \"conviva_session_tags\", \"ip address\" as \"conviva_ip_address\", \"cdn\" as \"conviva_cdn\", \"browser\" as \"conviva_browser\", \"conviva session id\" as \"conviva_conviva_session_id\", \"stream url\" as \"conviva_stream_url\", \"error list\" as \"conviva_error_list\", \"percentage complete\" as \"conviva_percentage_complete\", \"connection induced re-buffering time (ms)\" as \"conviva_connection_induced_re_buffering_time_ms\", \"video restart time (ms)\" as \"conviva_video_restart_time_ms\", \"re-joined count\" as \"conviva_re_joined_count\", \"vpf\" as \"conviva_vpf\", \"vpf error list\" as \"conviva_vpf_error_list\", \"content length (ms)\" as \"conviva_content_length_ms\", \"ended status\" as \"conviva_ended_status\", \"end time (unix time)\" as \"conviva_end_time_unix_time\", \"vsf_b\" as \"conviva_vsf_b\", \"vsf_b error list\" as \"conviva_vsf_b_error_list\", \"vsf_t\" as \"conviva_vsf_t\", \"vsf_t error list\" as \"conviva_vsf_t_error_list\", \"vpf_b\" as \"conviva_vpf_b\", \"vpf_b error list\" as \"conviva_vpf_b_error_list\", \"vpf_t\" as \"conviva_vpf_t\", \"vpf_t error list\" as \"conviva_vpf_t_error_list\", \"micro playing time(ms)\" as \"conviva_micro_playing_time_ms\", \"micro playing interruptions\" as \"conviva_micro_playing_interruptions\", \"micro buffering time(ms)\" as \"conviva_micro_buffering_timems\", \"micro buffering interruptions\" as \"conviva_micro_buffering_interruptions\", \"long rebuffering time(ms)\" as \"conviva_long_rebuffering_time_ms\", \"long rebuffering interruptions\" as \"conviva_long_rebuffering_interruptions\", \"eventdate\" as \"conviva_eventdate\" from ( SELECT \"viewerid\" ,\"asset\" , \"device/os\" , \"country\" , \"state\" , \"city\" , \"asn\" , \"isp\" , \"start time (unix time)\" , \"startup time (ms)\" , \"playing time (ms)\" , \"buffering time (ms)\" , \"interrupts\" , \"average bitrate (kbps)\" , \"startup error\" , \"url_extract_parameter\"(\"concat\"('http://localhost:80/test?', \"session tags\"), 'fcVideoSessionId') \"fcVideoSessionId\" , \"session tags\" , \"ip address\" , \"cdn\" , \"browser\" , \"conviva session id\" , \"stream url\" , \"error list\" , \"percentage complete\" , \"connection induced re-buffering time (ms)\" , \"video restart time (ms)\" , \"re-joined count\" , \"vpf\" , \"vpf error list\" , \"content length (ms)\" , \"ended status\" , \"end time (unix time)\" , \"vsf_b\" , \"vsf_b error list\" , \"vsf_t\" , \"vsf_t error list\" , \"vpf_b\" , \"vpf_b error list\" , \"vpf_t\" , \"vpf_t error list\" , \"micro playing time(ms)\" , \"micro playing interruptions\" , \"micro buffering time(ms)\" , \"micro buffering interruptions\" , \"long rebuffering time(ms)\" , \"long rebuffering interruptions\" , \"eventdate\" FROM example_aggregates.conviva_data ) where eventdate = '{event_date_w_o_hyphen}' and fcVideoSessionId <> 'NA') as a join (select * from (select abtestuserid, abvariant, advertiserid, app_center_version, app_name, app_version, appname, appversion, authorid, authorname, castdevice, commentarytype, contentid, contentlabel, contentname, contenttype, device_name, event_uuid, eventname, eventtime, favourite, fcvideosessionid, hashtag, ingestion_time, ip, isautoplay, iscast, matchid, matchname, mobile, model, network_provider, os, os_version, participated, pkey, playername, screen_resolution, screenname, sectionposition, sectiontitle, slotposition, source, sportname, streamurl, tags, tourformat, tourid, tourname, userid, utm_campaign, utm_content, utm_medium, utm_source, utm_term, utm_url, videocontenttype, videotag, viewerid, abexperiment, appcenterversion, channelname, collectionid, collectiontitle, deviceid, enrolled, filter, lastupdatedtime, location, loggedin, matchstatus, mediasource, pipstate, platform, posttype, screen_name, sectionid, sectionname, segmentid, sitetype, streamstatus, videosource, videotype, cast(null as varchar) as bucketid, cast(null as varchar) as current_page_url, cast(null as varchar) as companyuserid, cast(null as varchar) as dh_session_id, cast(null as varchar) as dh_web_id, cast(null as varchar) as fc_unique_device_id, cast(null as varchar) as isloggedin, cast(null as varchar) as ismobile, cast(null as varchar) as matchstarttime, cast(null as varchar) as partnername, cast(null as varchar) as partnerplatform, cast(null as varchar) as playertype, cast(null as varchar) as site, cast(null as varchar) as streamingstatus, cast(null as varchar) as user_agent, cast(null as varchar) as playerid, cast(null as varchar) as referrer, isuserentitled, ispremium, isrth, isfreetrial, 'example-app' as source_f, row_number() over (partition by fcvideosessionid order by eventtime asc) as rownumber, eventdate from example_events_processed.fc_videosessionstarted where eventdate = '{event_date_w_o_hyphen}' union all select abtestuserid, abvariant, advertiserid, app_center_version, app_name, app_version, appname, appversion, authorid, authorname, castdevice, commentarytype, contentid, contentlabel, contentname, contenttype, device_name, event_uuid, eventname, eventtime, favourite, fcvideosessionid, hashtag, ingestion_time, ip, isautoplay, iscast, matchid, matchname, mobile, model, network_provider, os, os_version, participated, pkey, playername, screen_resolution, screenname, sectionposition, sectiontitle, slotposition, source, sportname, streamurl, tags, tourformat, tourid, tourname, userid, utm_campaign, utm_content, utm_medium, utm_source, utm_term, utm_url, videocontenttype, videotag, viewerid, cast(null as varchar) as abexperiment, cast(null as varchar) as appcenterversion, cast(null as varchar) as channelname, cast(null as varchar) as collectionid, cast(null as varchar) as collectiontitle, cast(null as varchar) as deviceid, cast(null as varchar) as enrolled, cast(null as varchar) as filter, cast(null as varchar) as lastupdatedtime, cast(null as varchar) as location, cast(null as varchar) as loggedin, cast(null as varchar) as matchstatus, cast(null as varchar) as mediasource, cast(null as varchar) as pipstate, cast(null as varchar) as platform, cast(null as varchar) as posttype, cast(null as varchar) as screen_name, cast(null as varchar) as sectionid, cast(null as varchar) as sectionname, cast(null as varchar) as segmentid, cast(null as varchar) as sitetype, cast(null as varchar) as streamstatus, cast(null as varchar) as videosource, cast(null as varchar) as videotype, cast(null as varchar) as bucketid, cast(null as varchar) as current_page_url, cast(null as varchar) as companyuserid, cast(null as varchar) as dh_session_id, cast(null as varchar) as dh_web_id, cast(null as varchar) as fc_unique_device_id, cast(null as varchar) as isloggedin, cast(null as varchar) as ismobile, cast(null as varchar) as matchstarttime, cast(null as varchar) as partnername, cast(null as varchar) as partnerplatform, cast(null as varchar) as playertype, cast(null as varchar) as site, cast(null as varchar) as streamingstatus, cast(null as varchar) as user_agent, cast(null as varchar) as playerid, cast(null as varchar) as referrer, cast(null as varchar) as isuserentitled, cast(null as varchar) as ispremium, isrth, isfreetrial, 'partner-app' as source_f, row_number() over (partition by fcvideosessionid order by eventtime asc) as rownumber, eventdate from example_events_processed.fc_partner_videosessionstarted where eventdate = '{event_date_w_o_hyphen}' union all select distinct cast(null as varchar) as abtestuserid, cast(null as varchar) as abvariant, advertiserid, cast(null as varchar) as app_center_version, cast(null as varchar) as app_name, cast(null as varchar) as app_version, cast(null as varchar) as appname, cast(null as varchar) as appversion, authorid, authorname, cast(null as varchar) as castdevice, commentarytype, contentid, contentlabel, contentname, contenttype, cast(null as varchar) as device_name, event_uuid, eventname, eventtime, favourite, fcvideosessionid, cast(null as varchar) as hashtag, ingestion_time, ip, isautoplay, cast(null as varchar) as iscast, matchid, matchname, cast(null as varchar) as mobile, cast(null as varchar) as model, cast(null as varchar) as network_provider, cast(null as varchar) as os, cast(null as varchar) as os_version, cast(null as varchar) as participated, pkey, cast(null as varchar) as playername, screen_resolution, screenname, sectionposition, sectiontitle, slotposition, source, sportname, cast(null as varchar) as streamurl, tags, tourformat, tourid, tourname, userid, utm_campaign, utm_content, utm_medium, utm_source, utm_term, cast(null as varchar) as utm_url, videocontenttype, videotag, cast(null as varchar) as viewerid, cast(null as varchar) as abexperiment, cast(null as varchar) as appcenterversion, cast(null as varchar) as channelname, cast(null as varchar) as collectionid, cast(null as varchar) as collectiontitle, cast(null as varchar) as deviceid, cast(null as varchar) as enrolled, cast(null as varchar) as filter, cast(null as varchar) as lastupdatedtime, cast(null as varchar) as location, cast(null as varchar) as loggedin, matchstatus, cast(null as varchar) as mediasource, cast(null as varchar) as pipstate, platform, cast(null as varchar) as posttype, cast(null as varchar) as screen_name, sectionid, cast(null as varchar) as sectionname, cast(null as varchar) as segmentid, cast(null as varchar) as sitetype, cast(null as varchar) as streamstatus, cast(null as varchar) as videosource, videotype, bucketid, current_page_url, companyuserid, dh_session_id, dh_web_id, cast(null as varchar) as fc_unique_device_id, isloggedin, ismobile, matchstarttime, cast(null as varchar) as partnername, cast(null as varchar) as partnerplatform, playertype, site, streamingstatus, user_agent, playerid, referrer, cast(null as varchar) as isuserentitled, cast(null as varchar) as ispremium, cast(null as varchar) as isrth, isfreetrial, 'example-web' as source_f, row_number() over (partition by fcvideosessionid order by eventtime asc) as rownumber, eventdate from example_events_processed.fc_pwa_videosessionstarted where eventdate = '{event_date_w_o_hyphen}' union all select abtestuserid, abvariant, advertiserid, app_center_version, app_name, app_version, appname, appversion, authorid, authorname, castdevice, commentarytype, contentid, contentlabel, contentname, contenttype, device_name, event_uuid, eventname, eventtime, favourite, fcvideosessionid, hashtag, ingestion_time, ip, isautoplay, iscast, matchid, matchname, mobile, model, network_provider, os, os_version, participated, pkey, playername, screen_resolution, screenname, sectionposition, sectiontitle, slotposition, source, sportname, streamurl, tags, tourformat, tourid, tourname, userid, utm_campaign, utm_content, utm_medium, utm_source, utm_term, utm_url, videocontenttype, videotag, viewerid, cast(null as varchar) as abexperiment, cast(null as varchar) as appcenterversion, cast(null as varchar) as channelname, cast(null as varchar) as collectionid, cast(null as varchar) as collectiontitle, cast(null as varchar) as deviceid, cast(null as varchar) as enrolled, cast(null as varchar) as filter, cast(null as varchar) as lastupdatedtime, cast(null as varchar) as location, cast(null as varchar) as loggedin, cast(null as varchar) as matchstatus, cast(null as varchar) as mediasource, cast(null as varchar) as pipstate, cast(null as varchar) as platform, cast(null as varchar) as posttype, cast(null as varchar) as screen_name, cast(null as varchar) as sectionid, cast(null as varchar) as sectionname, cast(null as varchar) as segmentid, cast(null as varchar) as sitetype, cast(null as varchar) as streamstatus, cast(null as varchar) as videosource, cast(null as varchar) as videotype, cast(null as varchar) as bucketid, cast(null as varchar) as current_page_url, cast(null as varchar) as companyuserid, cast(null as varchar) as dh_session_id, cast(null as varchar) as dh_web_id, cast(null as varchar) as fc_unique_device_id, cast(null as varchar) as isloggedin, cast(null as varchar) as ismobile, cast(null as varchar) as matchstarttime, cast(null as varchar) as partnername, cast(null as varchar) as partnerplatform, cast(null as varchar) as playertype, cast(null as varchar) as site, cast(null as varchar) as streamingstatus, cast(null as varchar) as user_agent, cast(null as varchar) as playerid, cast(null as varchar) as referrer, cast(null as varchar) as isuserentitled, cast(null as varchar) as ispremium, isrth, isfreetrial, 'partner-app' as source_f, row_number() over (partition by fcvideosessionid order by eventtime asc) as rownumber, eventdate from company_events_processed.company_videosessionstarted where eventdate = '{event_date_w_o_hyphen}' union all select abtestuserid, abvariant, advertiserid, app_center_version, app_name, app_version, appname, appversion, authorid, authorname, castdevice, commentarytype, contentid, contentlabel, contentname, contenttype, device_name, event_uuid, eventname, eventtime, favourite, fcvideosessionid, hashtag, ingestion_time, ip, isautoplay, iscast, matchid, matchname, mobile, model, network_provider, os, os_version, participated, pkey, playername, screen_resolution, screenname, sectionposition, sectiontitle, slotposition, source, sportname, streamurl, tags, tourformat, tourid, tourname, userid, utm_campaign, utm_content, utm_medium, utm_source, utm_term, utm_url, videocontenttype, videotag, viewerid, cast(null as varchar) as abexperiment, cast(null as varchar) as appcenterversion, cast(null as varchar) as channelname, cast(null as varchar) as collectionid, cast(null as varchar) as collectiontitle, cast(null as varchar) as deviceid, cast(null as varchar) as enrolled, cast(null as varchar) as filter, cast(null as varchar) as lastupdatedtime, cast(null as varchar) as location, cast(null as varchar) as loggedin, cast(null as varchar) as matchstatus, cast(null as varchar) as mediasource, cast(null as varchar) as pipstate, cast(null as varchar) as platform, cast(null as varchar) as posttype, cast(null as varchar) as screen_name, cast(null as varchar) as sectionid, cast(null as varchar) as sectionname, cast(null as varchar) as segmentid, sitetype as sitetype, cast(null as varchar) as streamstatus, cast(null as varchar) as videosource, cast(null as varchar) as videotype, cast(null as varchar) as bucketid, cast(null as varchar) as current_page_url, cast(null as varchar) as companyuserid, cast(null as varchar) as dh_session_id, cast(null as varchar) as dh_web_id, cast(null as varchar) as fc_unique_device_id, cast(null as varchar) as isloggedin, cast(null as varchar) as ismobile, cast(null as varchar) as matchstarttime, cast(null as varchar) as partnername, cast(null as varchar) as partnerplatform, cast(null as varchar) as playertype, cast(null as varchar) as site, cast(null as varchar) as streamingstatus, cast(null as varchar) as user_agent, cast(null as varchar) as playerid, cast(null as varchar) as referrer, cast(null as varchar) as isuserentitled, cast(null as varchar) as ispremium, isrth, isfreetrial, 'partner-app-ext' as source_f, row_number() over (partition by fcvideosessionid order by eventtime asc) as rownumber, eventdate from example_events_processed.fc_app_partner_videosessionstarted where eventdate = '{event_date_w_o_hyphen}' ) where rownumber = 1) as b on a.conviva_fcVideoSessionId = b.fcvideosessionid";
    Set<String> result = sqlParser.getTableNames(query);
    Set<String> expected =
        new HashSet<>(
            Arrays.asList(
                "example_events_processed.fc_partner_videosessionstarted",
                "example_events_processed.fc_videosessionstarted",
                "example_aggregates.conviva_data",
                "example_events_processed.fc_pwa_videosessionstarted",
                "example_events_processed.fc_app_partner_videosessionstarted",
                "company_events_processed.company_videosessionstarted"));

    assertEquals(expected, new HashSet<>(result));
  }

  @Test
  @DisplayName(
      "getTableNames should extract table names from complex query with subqueries, joins and aggregations 3")
  void testGetTableNames3() {
    String query =
        "select id , case when id in (109942040, 89155848, 13278180, 44110304, 4813102, 128382689, 142000764, 1928305 ) then 'tg' when id in ( select userid from ( select a.userid, sum(amount) as cea, row_number() over( order by cea desc) as rank from ( select distinct userid from sporta_sandbox.user_persona where user_segment in ('Noobs', 'Probables', 'Sophomores' ) ) a left join example.example_uwtransactions b on a.userid=b.userid where date(b.createdat) between date('2022-07-01') and date('2022-08-28') and b.transtype =1 group by 1 ) where rank<=100000 ) then 'cg' end as tg_cg from example.example_userregistration";
    Set<String> result = sqlParser.getTableNames(query);
    Set<String> expected =
        new HashSet<>(
            Arrays.asList(
                "sporta_sandbox.user_persona",
                "example.example_userregistration",
                "example.example_uwtransactions"));

    assertEquals(expected, new HashSet<>(result));
  }

  @Test
  @DisplayName("getTableNames throws InvalidSqlException for invalid SQL query")
  void testGetTableNames5() {
    String query = "select a from group by a";
    assertThrows(InvalidSqlException.class, () -> sqlParser.getTableNames(query));
  }

  @Test
  @DisplayName("getTableNames should return empty set when the query is a non select query")
  void testGetTableNames6() {
    String query = "update users set name = 'John' where id = 1";
    Set<String> result = sqlParser.getTableNames(query);
    assertTrue(result.isEmpty());
  }

  @Test
  @DisplayName("getTableNames should return empty set for empty SQL query")
  void testGetTableNames7() {
    String query = "";
    Set<String> result = sqlParser.getTableNames(query);
    assertTrue(result.isEmpty());
  }
}
