name: Darwin SDK - Integration Tests

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'darwin-sdk/**'
      - 'darwin-compute/**'
      - 'darwin-cluster-manager/**'
      - '.github/workflows/darwin-sdk-integration.yml'

jobs:
  integration-test:
    name: Integration Test with Ray Cluster
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      KUBECONFIG: ./.setup/kindkubeconfig.yaml
      CONFIG_ENV: ./.setup/config.env

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Set up Go 1.18
        uses: actions/setup-go@v5
        with:
          go-version: '1.18'

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Install kind
        run: |
          # Download to /tmp to avoid conflict with kind directory in repo
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x /tmp/kind
          sudo mv /tmp/kind /usr/local/bin/kind
          kind --version

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/kubectl
          kubectl version --client

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: Cache Darwin SDK dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-darwin-sdk-${{ hashFiles('darwin-sdk/darwin/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-darwin-sdk-

      - name: Initialize Darwin configuration
        run: |
          # Enable only required services for darwin-sdk testing
          ./init.sh --dev-mode --all

      - name: Setup Darwin platform
        run: |
          ./setup.sh -y

      - name: Deploy Darwin platform
        run: |
          ./start.sh

      - name: Wait for platform to be ready
        run: |
          source $CONFIG_ENV
          echo "Waiting for Darwin platform to be ready..."
          
          # Wait for compute service
          echo "Checking darwin-compute..."
          kubectl wait --for=condition=ready pod -l app=compute -n darwin --timeout=300s || true
          
          # Wait for cluster-manager
          echo "Checking darwin-cluster-manager..."
          kubectl wait --for=condition=ready pod -l app=cluster-manager -n darwin --timeout=300s || true
          
          # Give services time to initialize
          sleep 30
          
          echo "Platform status:"
          kubectl get pods -n darwin
          kubectl get services -n darwin

      - name: Deploy Ray test cluster
        run: |
          source $CONFIG_ENV
          
          echo "Deploying Ray test cluster..."
          helm install ray-test ./darwin-cluster-manager/charts/ray-cluster \
            -n darwin \
            -f darwin-sdk/darwin/ray-cluster-test-values.yaml \
            --wait \
            --timeout 10m
          
          echo "Ray cluster deployed. Checking status..."
          kubectl get pods -n darwin -l ray.io/cluster=ray-test

      - name: Wait for Ray cluster to be ready
        run: |
          source $CONFIG_ENV
          
          echo "Waiting for Ray head node..."
          kubectl wait --for=condition=ready pod -l ray.io/node-type=head,ray.io/cluster=ray-test -n darwin --timeout=300s
          
          echo "Waiting for Ray worker nodes..."
          kubectl wait --for=condition=ready pod -l ray.io/node-type=worker,ray.io/cluster=ray-test -n darwin --timeout=300s
          
          echo "Ray cluster is ready!"
          kubectl get pods -n darwin -l ray.io/cluster=ray-test

      - name: Setup port-forward for Ray cluster
        run: |
          source $CONFIG_ENV
          
          # Get Ray head pod name
          RAY_HEAD_POD=$(kubectl get pods -n darwin -l ray.io/node-type=head,ray.io/cluster=ray-test -o jsonpath='{.items[0].metadata.name}')
          echo "Ray head pod: $RAY_HEAD_POD"
          
          # Port forward Ray client port (10001)
          kubectl port-forward -n darwin pod/$RAY_HEAD_POD 10001:10001 &
          
          # Wait for port-forward to be ready
          sleep 5
          
          echo "Port-forward established"

      - name: Install Darwin SDK
        working-directory: darwin-sdk/darwin
        run: |
          # Set version for build
          echo "SPARK_VERSION=3.5.0" > version.txt
          echo "BUILD_VERSION=1.0.0-ci" >> version.txt
          
          # Install in development mode
          pip install -e .
          pip install pytest pytest-mock
          
          # Verify installation
          python -c "import darwin; print('✅ Darwin SDK installed')"

      - name: Run Ray cluster connectivity test
        working-directory: darwin-sdk/darwin
        env:
          RAY_ADDRESS: ray://localhost:10001
          ENV: CI
          CLUSTER_ID: ray-test
        run: |
          echo "Testing Ray cluster connectivity..."
          python cluster_test.py

      - name: Run integration tests
        working-directory: darwin-sdk/darwin
        env:
          RAY_ADDRESS: ray://localhost:10001
          ENV: CI
          CLUSTER_ID: ray-test
          DARWIN_COMPUTE_URL: http://localhost/compute
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: us-east-1
          AWS_EC2_METADATA_DISABLED: true
        run: |
          echo "Running Darwin SDK integration tests..."
          pytest tests/test_integration.py \
            -v \
            --tb=short \
            --junitxml=integration-test-results.xml

      - name: Test darwin.init() functionality
        working-directory: darwin-sdk/darwin
        env:
          RAY_ADDRESS: ray://localhost:10001
          ENV: CI
          CLUSTER_ID: ray-test
          DARWIN_COMPUTE_URL: http://localhost/compute
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: us-east-1
          AWS_EC2_METADATA_DISABLED: true
        run: |
          echo "Testing darwin.init() with mocked compute service..."
          python -c "
          import os
          from unittest.mock import MagicMock, patch
          import darwin
          
          # Mock compute service response
          mock_response = {
              'data': {
                  'cluster_id': 'ray-test',
                  'name': 'test-cluster',
                  'status': 'RUNNING',
                  'has_ondemand_worker_group': True,
                  'spark_config': {
                      'spark.app.name': 'darwin-ci-test',
                      'spark.master': 'local[2]',
                      'spark.executor.cores': '1',
                      'spark.executor.memory': '1G',
                      'spark.driver.memory': '1G',
                      'spark.darwin.workingDir': '/tmp/darwin',
                      'spark.darwin.enableRemoteShuffle': 'false',
                      'spark.darwin.dynamicAllocation.enabled': 'false',
                      'spark.darwin.loggingLevel': 'WARN'
                  }
              }
          }
          
          # Create mock
          mock_data = MagicMock()
          mock_data.cluster_id = mock_response['data']['cluster_id']
          mock_data.name = mock_response['data']['name']
          mock_data.status = mock_response['data']['status']
          mock_data.has_ondemand_worker_group = mock_response['data']['has_ondemand_worker_group']
          mock_data.spark_config = mock_response['data']['spark_config']
          
          mock_cluster_response = MagicMock()
          mock_cluster_response.data = mock_data
          
          mock_service = MagicMock()
          mock_service.get_compute_metadata.return_value = mock_cluster_response
          
          with patch('darwin.compute.service.ComputeService', return_value=mock_service):
              # Test darwin.init_spark()
              spark = darwin.init_spark()
              print('✅ darwin.init_spark() successful')
              
              # Test basic Spark operation
              df = spark.range(100)
              count = df.count()
              assert count == 100, f'Expected 100, got {count}'
              print(f'✅ Spark DataFrame operation successful (count={count})')
              
              # Stop Spark
              darwin.stop_spark()
              print('✅ darwin.stop_spark() successful')
          
          print('✅ All darwin.init() tests passed!')
          "

      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: darwin-sdk/darwin/integration-test-results.xml
          retention-days: 7

      - name: Show Ray cluster logs on failure
        if: failure()
        run: |
          source $CONFIG_ENV || true
          echo "=== Ray Head Pod Logs ==="
          kubectl logs -n darwin -l ray.io/node-type=head,ray.io/cluster=ray-test --tail=100 || true
          echo ""
          echo "=== Ray Worker Pod Logs ==="
          kubectl logs -n darwin -l ray.io/node-type=worker,ray.io/cluster=ray-test --tail=100 || true

      - name: Show platform status on failure
        if: failure()
        run: |
          source $CONFIG_ENV || true
          echo "=== Pods Status ==="
          kubectl get pods -A || true
          echo ""
          echo "=== Services Status ==="
          kubectl get services -A || true
          echo ""
          echo "=== Recent Events ==="
          kubectl get events -A --sort-by='.lastTimestamp' | tail -30 || true
          echo ""
          echo "=== Compute Service Logs ==="
          kubectl logs -n darwin -l app=compute --tail=100 || true
          echo ""
          echo "=== Cluster Manager Logs ==="
          kubectl logs -n darwin -l app=cluster-manager --tail=100 || true

      - name: Integration test summary
        if: always()
        run: |
          echo "## Darwin SDK Integration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f darwin-sdk/darwin/integration-test-results.xml ]; then
            echo "✅ Integration tests completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Integration tests failed or did not run" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Ray Cluster Status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          source $CONFIG_ENV || true
          kubectl get pods -n darwin -l ray.io/cluster=ray-test 2>&1 || echo "Could not get Ray cluster status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
