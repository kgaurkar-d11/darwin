# Darwin ML Platform - Agent Entry Point

Darwin is an enterprise-grade, end-to-end machine learning platform. This repository handles **deployment orchestration** - building Docker images and deploying the entire platform to Kubernetes using Helm charts.

---

## ğŸš€ Setup Workflow

```bash
1. ./init.sh      # Interactive service selection wizard (creates .setup/enabled-services.yaml)
2. ./setup.sh     # Build images, create Kind cluster, push to local registry
3. ./start.sh     # Deploy to Kubernetes via Helm
```

**Flags:**
- `./init.sh --all` - Enable all services without prompts
- `./setup.sh -y` - Skip prompts (auto-answer yes)

---

## ğŸ—ï¸ Project Architecture

### Platform Components

| Feature | Applications | Description |
|---------|-------------|-------------|
| **Compute** | darwin-compute, darwin-cluster-manager | Ray cluster management & K8s orchestration |
| **Workspace** | darwin-workspace | Project & Jupyter environment management |
| **Feature Store** | darwin-ofs-v2, darwin-ofs-v2-admin, darwin-ofs-v2-consumer | Online feature serving (<10ms latency) |
| **MLflow** | darwin-mlflow, darwin-mlflow-app | Experiment tracking & model registry |
| **Serve** | ml-serve-app, artifact-builder | Model deployment & Docker image building |
| **Catalog** | darwin-catalog | Data asset discovery & lineage |
| **Chronos** | chronos, chronos-consumer | Event processing & metadata tracking |
| **Workflow** | darwin-workflow | ML pipeline orchestration (Airflow-based) |

### Datastores

| Datastore | Usage |
|-----------|-------|
| MySQL | Metadata storage for all services |
| Cassandra | Feature Store values (high-throughput) |
| OpenSearch | Chronos events, Compute metadata |
| Kafka + Zookeeper | Event streaming, feature materialization |
| LocalStack | S3 emulation for artifacts |
| Airflow | Workflow DAG execution |
| Elasticsearch | Workflow search (alternative to OpenSearch) |

### Infrastructure Operators

- **KubeRay Operator** (v1.1.0) - Ray cluster lifecycle management
- **Nginx** - Ingress controller
- **Grafana** - Monitoring dashboards

---

## ğŸ“ Key Files Reference

| File | Purpose |
|------|---------|
| `init.sh` | Interactive service selection wizard (run first) |
| `setup.sh` | Creates cluster & builds all images |
| `start.sh` | Deploys platform via Helm with config overrides |
| `services.yaml` | Application registry - defines available services, datastores, operators |
| `service-dependencies.yaml` | Service-to-service and service-to-datastore dependencies |
| `.setup/config.env` | Runtime configuration (generated) |
| `.setup/enabled-services.yaml` | User-selected services config (generated by init.sh) |
| `helm/darwin/` | Main Helm umbrella chart |
| `kind/` | Local Kubernetes cluster config |
| `deployer/` | Base images (Python, Java, Go) and build scripts |

---

## ğŸ”§ Agent Instructions

1. **Run `init.sh` first** - This creates `.setup/enabled-services.yaml` with user's service selections
2. **Load prompts on-demand** - Only read prompts relevant to the current task
3. **Check `.setup/enabled-services.yaml`** - This is the source of truth for which services are enabled
4. **Check `services.yaml`** - Defines available applications, datastores, and operators
5. **Check `service-dependencies.yaml`** - Understand service dependencies before enabling/disabling
6. **Check `.setup/config.env`** - Contains current KUBECONFIG and DOCKER_REGISTRY
7. **Respect `.odin/` conventions** - Each submodule must have build.sh, setup.sh, start.sh

### Common Operations

#### Check Cluster Status
```bash
kubectl get pods -n darwin          # Darwin services
kubectl get pods -n ray             # Ray clusters
kubectl get pods -n serve           # Model serving pods
```

#### Rebuild a Single Service
```bash
# Build and push image
sh deployer/scripts/image-builder.sh -a <app-name> -t <base-path> -p <path> -e <base-image> -r $DOCKER_REGISTRY

# Restart deployment
kubectl rollout restart deployment/<service-name> -n darwin
```

#### Access Services (Local)
- Compute: `http://localhost/compute/*`
- Feature Store: `http://localhost/feature-store/*`
- MLflow UI: `http://localhost/mlflow-app/*`
- Chronos: `http://localhost/chronos/*`
- Catalog: `http://localhost/darwin-catalog/*`
- Workspace: `http://localhost/workspace/*`
- Workflow: `http://localhost/workflow/*`

### Adding New Services

1. Add entry to `services.yaml` under `applications:`
2. Add dependencies to `service-dependencies.yaml`
3. Create Helm subchart in `helm/darwin/charts/services/`
4. Update `init.sh` if it's a new feature group
5. Update `start.sh` with helm path mapping in `get_helm_path()`

### Adding New Datastores

1. Add entry to `services.yaml` under `datastores:`
2. Create templates in `helm/darwin/charts/datastores/templates/`
3. Update `service-dependencies.yaml` for services that need it

---

## ğŸ“¦ Service Dependencies (Quick Reference)

```
darwin-compute         â†’ darwin-cluster-manager
darwin-workspace       â†’ darwin-compute
darwin-workflow        â†’ darwin-compute, darwin-cluster-manager
ml-serve-app           â†’ artifact-builder, darwin-cluster-manager, darwin-mlflow-app
darwin-mlflow-app      â†’ darwin-mlflow
darwin-ofs-v2          â†’ darwin-ofs-v2-admin
darwin-ofs-v2-consumer â†’ darwin-ofs-v2-admin
chronos-consumer       â†’ chronos
```

---

## ğŸ› ï¸ CLI Tools

### Hermes CLI
Command-line tool for model deployment:
```bash
source hermes-cli/.venv/bin/activate
hermes configure
hermes create-serve --name my-model --type api --space serve
hermes deploy-model --serve-name my-model --model-uri mlflow-artifacts:/...
```

> ğŸ“– Full documentation: `hermes-cli/CLI.md`

---

## ğŸ“Š Ray Runtimes

| Image | Ray Version | Python | Spark |
|-------|-------------|--------|-------|
| `ray:2.37.0` | 2.37.0 | 3.10 | - |
| `ray:2.53.0` | 2.53.0 | 3.10 | - |
| `ray:2.37.0-darwin-sdk` | 2.37.0 | 3.10 | 3.5.0 |

Darwin SDK Runtime includes Spark integration for distributed data processing.

---

## ğŸ“š Additional Documentation

| Document | Location |
|----------|----------|
| Main README | `README.md` |
| Hermes CLI | `hermes-cli/CLI.md` |
| Helm Umbrella Chart | `helm/darwin/UMBRELLA_CHART.md` |
| Deployment Order | `helm/darwin/DEPLOYMENT_ORDER.md` |
| Feature Store Architecture | `feature-store/ARCHITECTURE.md` |

---

## ğŸ› Troubleshooting

### Common Issues

**Cluster not reachable:**
```bash
source .setup/config.env
kubectl cluster-info
```

**Service not starting:**
```bash
kubectl describe pod <pod-name> -n darwin
kubectl logs <pod-name> -n darwin
```

**Helm deployment failed:**
```bash
helm status darwin -n darwin
helm history darwin -n darwin
```

**LocalStack S3 issues:**
```bash
kubectl port-forward svc/darwin-localstack -n darwin 4566:4566
AWS_ACCESS_KEY_ID=test AWS_SECRET_ACCESS_KEY=test aws s3 ls --endpoint-url=http://localhost:4566
```

---

## ğŸ¯ Quick Task Navigation

| Task | Steps |
|------|-------|
| **First-time setup** | Run `./init.sh` â†’ `./setup.sh` â†’ `./start.sh` |
| **Add new microservice** | Edit `services.yaml` â†’ Add Helm chart â†’ Update `init.sh`/`start.sh` |
| **Enable/disable service** | Edit `.setup/enabled-services.yaml` â†’ Run `./start.sh` |
| **Rebuild images** | Run `./setup.sh -y` |
| **Debug pod** | `kubectl logs/describe` â†’ Check service dependencies |
| **Deploy model** | Use Hermes CLI (see `hermes-cli/CLI.md`) |
