name: Darwin CI

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'darwin-catalog/**'

jobs:
  build-catalog:
    name: Build & Test darwin-catalog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('darwin-catalog/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build and run unit tests
        working-directory: darwin-catalog
        run: mvn clean compile test -B

      - name: Run integration tests
        working-directory: darwin-catalog
        run: mvn verify -P integration-tests -DskipTests -B

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            darwin-catalog/target/surefire-reports/
            darwin-catalog/target/failsafe-reports/
          retention-days: 7

  deploy-platform:
    name: Deploy Darwin Platform
    runs-on: ubuntu-latest
    needs: build-catalog

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Install kind
        run: |
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x /tmp/kind
          sudo mv /tmp/kind /usr/local/bin/kind
          kind --version

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/kubectl
          kubectl version --client

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: Initialize Darwin configuration
        run: ./init.sh --all

      - name: Setup Darwin platform (build images and create cluster)
        run: ./setup.sh -y

      - name: Deploy Darwin platform
        run: ./start.sh

      - name: Verify deployment
        run: |
          source config.env
          echo "Waiting for pods to be ready..."
          sleep 30
          kubectl get pods -A
          kubectl get services -A

      - name: Show deployment status
        if: always()
        run: |
          source config.env || true
          echo "=== Pods Status ==="
          kubectl get pods -A || true
          echo ""
          echo "=== Services Status ==="
          kubectl get services -A || true
          echo ""
          echo "=== Events (last 20) ==="
          kubectl get events -A --sort-by='.lastTimestamp' | tail -20 || true

